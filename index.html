<!doctype html>
<html lang="es">
<head>
<meta charset="utf-8">
<meta name="viewport" content="width=device-width, initial-scale=1">
<title>Asistencia Empleados</title>

<style>
body{margin:0;font-family:system-ui;background:#0b0f14;color:#e9eef5}
.wrap{max-width:820px;margin:auto;padding:20px}
.card{background:#111826;border:1px solid #1f2a3a;border-radius:14px;padding:16px;margin-bottom:16px}
input,button,select{width:100%;padding:12px;margin-top:8px;border-radius:10px;border:1px solid #2a3a52;background:#0e1522;color:#fff}
button{cursor:pointer;background:#173155}
button:hover{filter:brightness(1.1)}
.ok{color:#6ee7b7}
.warn{color:#fde68a}
.bad{color:#fca5a5}
table{width:100%;border-collapse:collapse;font-size:13px}
th,td{border-bottom:1px solid #243246;padding:8px;text-align:left;vertical-align:top}
.row{display:flex;gap:10px;flex-wrap:wrap}
.row > *{flex:1 1 180px}
.small{font-size:12px;opacity:.9}
hr{border:0;border-top:1px solid #243246;margin:14px 0}
.badbtn{background:#5a1720}
</style>
</head>

<body>
<div class="wrap">

<h2>Control de Asistencia</h2>

<div id="msg" class="card" style="display:none"></div>

<div id="login" class="card">
  <h3>Acceso</h3>
  <input id="code" placeholder="Número de empleado o ADMIN">
  <input id="pin" type="password" placeholder="PIN">
  <button onclick="login()">Entrar</button>
  <p class="small">Tip: para entrar como admin usa <b>ADMIN</b> como usuario.</p>
</div>

<div id="employee" class="card" style="display:none">
  <h3 id="empName"></h3>
  <p>Sede: <b id="siteName"></b></p>
  <button onclick="mark('ENTRADA')">Marcar Entrada</button>
  <button onclick="mark('SALIDA')">Marcar Salida</button>
  <button onclick="logout()">Salir</button>
</div>

<div id="admin" class="card" style="display:none">
  <h3>Panel Admin</h3>

  <div class="card" style="margin:12px 0;background:#0f1724">
    <h4>Usuarios (crear / editar / borrar)</h4>

    <div class="row">
      <input id="u_code" placeholder="Código (ej. 1003)">
      <input id="u_name" placeholder="Nombre (ej. Ana Torres)">
      <input id="u_pin" placeholder="PIN (4-8 dígitos)" inputmode="numeric">
    </div>
    <div class="row">
      <button onclick="saveUser()">Guardar (crear/actualizar)</button>
      <button class="badbtn" onclick="deleteUser()">Borrar usuario</button>
    </div>
    <p class="small">Selecciona un usuario de la tabla para editarlo. Nota: todo se guarda en <b>este dispositivo</b> (localStorage).</p>

    <table style="margin-top:12px">
      <thead>
        <tr>
          <th>Código</th>
          <th>Nombre</th>
          <th>PIN</th>
          <th>Acción</th>
        </tr>
      </thead>
      <tbody id="usersTable"></tbody>
    </table>

    <hr>

    <h4>Seguridad (Admin)</h4>
    <div class="row">
      <input id="admin_pin_new" type="password" placeholder="Nuevo PIN Admin (4-8 dígitos)" inputmode="numeric">
      <button onclick="changeAdminPin()">Cambiar PIN Admin</button>
    </div>
    <p class="small">Recomendación: si esto se usará en producción, mueve usuarios/PINs a un backend. En HTML+localStorage cualquiera con acceso al archivo puede verlos.</p>
  </div>

  <div class="row">
    <button onclick="exportCSV()">Exportar CSV</button>
    <button class="badbtn" onclick="clearData()">Borrar registros</button>
  </div>

  <table style="margin-top:12px">
    <thead>
      <tr>
        <th>Fecha</th>
        <th>Empleado</th>
        <th>Tipo</th>
        <th>Distancia (m)</th>
        <th>Precisión</th>
        <th>Estatus</th>
      </tr>
    </thead>
    <tbody id="table"></tbody>
  </table>

  <button onclick="logout()">Salir</button>
</div>

</div>

<script>
// ======================
// Configuración
// ======================
const SITE={name:"Planta Principal",lat:25.6866,lng:-100.3161,radius:200};

// Defaults (se copian a localStorage solo si NO hay usuarios guardados aún)
const DEFAULT_EMPLOYEES=[
  {code:"1001",name:"Juan Pérez",pin:"1111"},
  {code:"1002",name:"María López",pin:"2222"}
];

const DEFAULT_ADMIN_PIN="9999";

// LocalStorage keys
const LS={
  session:"session",
  records:"records",
  employees:"employees",
  adminPin:"admin_pin"
};

const $=id=>document.getElementById(id);

function msg(t,c="ok"){
  $("msg").style.display="block";
  $("msg").innerHTML=`<span class="${c}">${t}</span>`;
  setTimeout(()=>{$("msg").style.display="none"},4000);
}

// ======================
// Datos (empleados/admin) desde localStorage
// ======================
function getEmployees(){
  return JSON.parse(localStorage.getItem(LS.employees) || "[]");
}
function setEmployees(list){
  localStorage.setItem(LS.employees, JSON.stringify(list));
}
function getAdminPin(){
  return localStorage.getItem(LS.adminPin) || DEFAULT_ADMIN_PIN;
}
function setAdminPin(pin){
  localStorage.setItem(LS.adminPin, pin);
}
function bootstrapStorage(){
  // Empleados
  if(!localStorage.getItem(LS.employees)){
    setEmployees(DEFAULT_EMPLOYEES);
  }
  // Admin PIN
  if(!localStorage.getItem(LS.adminPin)){
    setAdminPin(DEFAULT_ADMIN_PIN);
  }
}

// ======================
// Login / Session
// ======================
function login(){
  const c=$("code").value.trim();
  const p=$("pin").value.trim();
  if(!c||!p) return msg("Completa los campos","warn");

  if(c.toUpperCase()==="ADMIN"){
    if(p!==getAdminPin()) return msg("PIN incorrecto","bad");
    localStorage.setItem(LS.session,"admin");
    showAdmin();
    return;
  }

  const employees=getEmployees();
  const emp=employees.find(e=>e.code===c && e.pin===p);
  if(!emp) return msg("Datos incorrectos","bad");

  localStorage.setItem(LS.session,emp.code);
  showEmployee(emp);
}

function logout(){
  localStorage.removeItem(LS.session);
  location.reload();
}

function showEmployee(emp){
  $("login").style.display="none";
  $("employee").style.display="block";
  $("empName").innerText=emp.name;
  $("siteName").innerText=SITE.name;
}

function showAdmin(){
  $("login").style.display="none";
  $("admin").style.display="block";
  renderRecords();
  renderUsers();
}

// ======================
// Asistencia
// ======================
function mark(type){
  navigator.geolocation.getCurrentPosition(pos=>{
    const d=distance(pos.coords.latitude,pos.coords.longitude,SITE.lat,SITE.lng);
    const status=d<=SITE.radius?"approved":"rejected";
    const rec={
      date:new Date().toISOString(),
      emp:localStorage.getItem(LS.session),
      type,
      dist:Math.round(d),
      acc:Math.round(pos.coords.accuracy),
      status
    };
    const data=JSON.parse(localStorage.getItem(LS.records)||"[]");
    data.unshift(rec);
    localStorage.setItem(LS.records,JSON.stringify(data));
    msg(`Registro ${status}`,status==="approved"?"ok":"bad");
  },()=>msg("Error GPS","bad"),{enableHighAccuracy:true});
}

function renderRecords(){
  const data=JSON.parse(localStorage.getItem(LS.records)||"[]");
  $("table").innerHTML=data.map(r=>`
    <tr>
      <td>${r.date}</td>
      <td>${r.emp}</td>
      <td>${r.type}</td>
      <td>${r.dist}</td>
      <td>${r.acc}</td>
      <td>${r.status}</td>
    </tr>`).join("");
}

function exportCSV(){
  const data=JSON.parse(localStorage.getItem(LS.records)||"[]");
  let csv="Fecha,Empleado,Tipo,Distancia,Precision,Estatus\n";
  data.forEach(r=>csv+=`${r.date},${r.emp},${r.type},${r.dist},${r.acc},${r.status}\n`);
  const a=document.createElement("a");
  a.href=URL.createObjectURL(new Blob([csv],{type:"text/csv"}));
  a.download="asistencia.csv";
  a.click();
}

function clearData(){
  if(confirm("¿Borrar todo?")){
    localStorage.removeItem(LS.records);
    renderRecords();
  }
}

// ======================
// Admin: CRUD Usuarios
// ======================
function sanitizeDigits(v){
  return (v||"").replace(/\D/g,"");
}

function saveUser(){
  const code=$("u_code").value.trim();
  const name=$("u_name").value.trim();
  const pin=sanitizeDigits($("u_pin").value.trim());

  if(!code || !name || !pin) return msg("Completa código, nombre y PIN","warn");
  if(pin.length<4 || pin.length>8) return msg("El PIN debe tener 4 a 8 dígitos","warn");
  if(code.toUpperCase()==="ADMIN") return msg("El código 'ADMIN' está reservado","warn");

  const employees=getEmployees();
  const idx=employees.findIndex(e=>e.code===code);
  if(idx>=0){
    employees[idx]={code,name,pin};
    msg("Usuario actualizado","ok");
  }else{
    employees.unshift({code,name,pin});
    msg("Usuario creado","ok");
  }
  setEmployees(employees);
  renderUsers();
  clearUserForm(false);
}

function deleteUser(){
  const code=$("u_code").value.trim();
  if(!code) return msg("Escribe o selecciona un código","warn");
  if(!confirm(`¿Borrar al usuario ${code}?`)) return;

  const employees=getEmployees();
  const next=employees.filter(e=>e.code!==code);
  if(next.length===employees.length) return msg("No existe ese usuario","warn");

  setEmployees(next);
  msg("Usuario borrado","ok");
  renderUsers();
  clearUserForm(true);
}

function fillUserForm(code){
  const employees=getEmployees();
  const emp=employees.find(e=>e.code===code);
  if(!emp) return;
  $("u_code").value=emp.code;
  $("u_name").value=emp.name;
  $("u_pin").value=emp.pin;
}

function clearUserForm(clearCode=true){
  if(clearCode) $("u_code").value="";
  $("u_name").value="";
  $("u_pin").value="";
}

function renderUsers(){
  const employees=getEmployees();
  $("usersTable").innerHTML = employees.map(e=>`
    <tr>
      <td>${e.code}</td>
      <td>${e.name}</td>
      <td>${"•".repeat(Math.min(e.pin.length,8))}</td>
      <td><button onclick="fillUserForm('${e.code.replace(/'/g,"\'")}')">Editar</button></td>
    </tr>
  `).join("") || `<tr><td colspan="4" class="warn">No hay usuarios</td></tr>`;
}

function changeAdminPin(){
  const newPin=sanitizeDigits($("admin_pin_new").value.trim());
  if(!newPin) return msg("Escribe un PIN nuevo","warn");
  if(newPin.length<4 || newPin.length>8) return msg("El PIN debe tener 4 a 8 dígitos","warn");
  setAdminPin(newPin);
  $("admin_pin_new").value="";
  msg("PIN Admin actualizado","ok");
}

// ======================
// Utilidades
// ======================
function distance(lat1,lng1,lat2,lng2){
  const R=6371000;
  const dLat=(lat2-lat1)*Math.PI/180;
  const dLng=(lng2-lng1)*Math.PI/180;
  const a=Math.sin(dLat/2)**2+
    Math.cos(lat1*Math.PI/180)*Math.cos(lat2*Math.PI/180)*Math.sin(dLng/2)**2;
  return 2*R*Math.asin(Math.sqrt(a));
}

// ======================
// Inicio
// ======================
(function(){
  bootstrapStorage();
  const s=localStorage.getItem(LS.session);
  if(s==="admin") showAdmin();
  else if(s){
    const emp=getEmployees().find(e=>e.code===s);
    if(emp) showEmployee(emp);
  }
})();
</script>

</body>
</html>
