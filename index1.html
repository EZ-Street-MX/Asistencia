<!DOCTYPE html>
<html lang="es">
<head>
<meta charset="UTF-8" />
<meta name="viewport" content="width=device-width, initial-scale=1" />
<title>EZ Street | Asistencia</title>
<style>
  :root{
    --bg:#0b1220; --card:#111a2e; --line:#24324f; --muted:#b8c3d6;
    --btn:#1f3b6d; --btn2:#274a86; --danger:#7a1f2a; --ok:#2c7a4b;
  }
  body{font-family:Arial,system-ui,-apple-system,Segoe UI,Roboto,sans-serif;background:var(--bg);color:#fff;margin:0;padding:20px}
  .card{max-width:860px;margin:0 auto 14px auto;background:var(--card);padding:18px;border-radius:12px;box-shadow:0 10px 30px rgba(0,0,0,.25)}
  h2,h3,h4{margin:0 0 10px 0}
  .row{display:flex;gap:10px;flex-wrap:wrap}
  .row > *{flex:1 1 160px}
  input,select{width:100%;padding:10px;border-radius:10px;border:1px solid var(--line);background:#0f1830;color:#fff;outline:none}
  input::placeholder{color:#6f7ea0}
  button{width:100%;padding:12px;margin-top:10px;border:none;border-radius:10px;background:var(--btn);color:#fff;font-size:16px;cursor:pointer}
  button:hover{background:var(--btn2)}
  .btn-inline{width:auto;padding:8px 10px;margin:0;border-radius:10px;font-size:14px}
  .btn-danger{background:var(--danger)}
  .btn-danger:hover{filter:brightness(1.1)}
  .btn-ok{background:var(--ok)}
  .btn-ok:hover{filter:brightness(1.1)}
  .hidden{display:none}
  .msg{margin:8px 0 0 0;color:#ff8a8a;min-height:18px}
  table{width:100%;border-collapse:collapse;margin-top:12px}
  th,td{border-bottom:1px solid var(--line);padding:8px;text-align:left;vertical-align:top}
  th{color:var(--muted);font-weight:600;font-size:13px}
  td{font-size:14px}
  .pill{display:inline-block;padding:3px 8px;border-radius:999px;background:#0f1830;border:1px solid var(--line);color:var(--muted);font-size:12px}
  .tabs{display:flex;gap:10px;flex-wrap:wrap;margin:10px 0 0 0}
  .tab{flex:1 1 160px;padding:10px;border-radius:10px;background:#0f1830;border:1px solid var(--line);color:#fff;cursor:pointer}
  .tab.active{background:var(--btn);border-color:transparent}
  .subtle{color:var(--muted);font-size:13px;line-height:1.35}
  .grid2{display:grid;grid-template-columns:1fr;gap:10px}
  @media(min-width:900px){ .grid2{grid-template-columns:1fr 1fr} }
  a{color:#89b4ff;text-decoration:none}
  a:hover{text-decoration:underline}
  .toast{position:fixed;left:50%;bottom:18px;transform:translateX(-50%);
    background:#0f1830;border:1px solid var(--line);color:#fff;padding:10px 14px;border-radius:12px;
    box-shadow:0 10px 30px rgba(0,0,0,.35);max-width:92vw;display:none;z-index:9999}
  .mono{font-family:ui-monospace,SFMono-Regular,Menlo,Monaco,Consolas,monospace}
</style>
</head>
<body>
<div class="toast" id="toast"></div>

<!-- LOGIN -->
<div class="card" id="login">
  <h2>Control de Asistencia</h2>
  <div class="subtle">Accede como <b>ADMIN2</b> o como empleado (C√≥digo o Nombre + PIN).</div>
  <div class="msg" id="msg"></div>
  <div class="row">
    <input id="user" placeholder="C√≥digo o Nombre o ADMIN2" autocomplete="username">
    <input id="pin" type="password" placeholder="PIN" autocomplete="current-password" inputmode="numeric">
  </div>
  <button onclick="doLogin()">Entrar</button>
</div>

<!-- ADMIN -->
<div class="card hidden" id="adminWrap">
  <h3>Panel Admin <span class="pill">Admin activo: ADMIN2</span></h3>
  <div class="subtle">
    ‚úÖ Esta versi√≥n <b>lee registros nuevos y viejos</b> (compatibilidad) y muestra ubicaci√≥n en entrada/salida.
    <br>‚ö†Ô∏è Todo se guarda en <b>este dispositivo</b> (localStorage).
  </div>

  <div class="tabs">
    <div class="tab active" id="tabUsers" onclick="showAdminTab('users')">Usuarios</div>
    <div class="tab" id="tabLogs" onclick="showAdminTab('logs')">Registros</div>
  </div>

  <!-- USERS TAB -->
  <div id="adminUsers">
    <h4 style="margin-top:14px">Crear / editar empleado</h4>
    <div class="row">
      <input id="eCode" placeholder="C√≥digo (ej. 1003)" inputmode="numeric">
      <input id="eName" placeholder="Nombre (ej. Luis Garc√≠a)">
      <input id="ePin" placeholder="PIN (4-8 d√≠gitos)" inputmode="numeric">
    </div>
    <div class="row">
      <button class="btn-ok" onclick="saveEmp()">Guardar</button>
      <button class="btn-danger" onclick="clearEmpFields()">Limpiar</button>
    </div>

    <table>
      <thead><tr><th>C√≥digo</th><th>Nombre</th><th>PIN</th><th>Acci√≥n</th></tr></thead>
      <tbody id="empTable"></tbody>
    </table>

    <div class="row" style="margin-top:8px">
      <button class="btn-inline" onclick="diagnostico()">Diagn√≥stico (ver conteo de registros)</button>
      <button class="btn-inline btn-danger" onclick="clearRecords()">Borrar TODOS los registros</button>
    </div>
  </div>

  <!-- LOGS TAB -->
  <div id="adminLogs" class="hidden">
    <h4 style="margin-top:14px">Registros por d√≠a</h4>
    <div class="grid2">
      <div>
        <div class="subtle">Selecciona un d√≠a y ver√°s el panel de ese d√≠a.</div>
        <div class="row" style="margin-top:8px">
          <input id="dayPicker" type="date">
          <button class="btn-inline" onclick="setToday()">Hoy</button>
          <button class="btn-inline" onclick="renderDay(true)">Actualizar</button>
        </div>
        <div class="row" style="margin-top:8px">
          <button class="btn-inline" onclick="exportDayCSV()">Exportar CSV (d√≠a)</button>
          <button class="btn-inline btn-danger" onclick="deleteDay()">Borrar d√≠a</button>
        </div>
      </div>
      <div>
        <div class="subtle"><b>Resumen</b>: total de horas por empleado.</div>
        <div id="daySummary" style="margin-top:10px"></div>
      </div>
    </div>

    <h4 style="margin-top:14px">Detalle (Entrada / Salida / Ubicaci√≥n)</h4>
    <div class="subtle">Total = suma de pares <b>Entrada ‚Üí Salida</b> en orden.</div>
    <div id="dayDetails"></div>
  </div>

  <button style="margin-top:16px" onclick="logout()">Salir</button>
</div>

<!-- EMPLOYEE -->
<div class="card hidden" id="empWrap">
  <h3 id="empName"></h3>
  <div class="subtle" id="empInfo"></div>

  <button class="btn-ok" onclick="mark('Entrada')">Marcar Entrada</button>
  <button onclick="mark('Salida')">Marcar Salida</button>

  <div class="subtle" style="margin-top:12px">
    üìç Si el GPS est√° permitido, se guarda ubicaci√≥n en <b>Entrada</b> y <b>Salida</b>.
  </div>

  <div style="margin-top:14px">
    <h4 style="margin-bottom:6px">√öltimos registros de hoy (este dispositivo)</h4>
    <div id="empLast"></div>
  </div>

  <button style="margin-top:16px" onclick="logout()">Salir</button>
</div>

<script>
const ADMIN_USER="ADMIN2", ADMIN_PIN="4321";
const K_EMP="employees", K_REC="records", K_TOUCH="records_touch";

// helpers storage
function lsGet(key,fallback){ try{ const v=localStorage.getItem(key); return (v==null)?fallback:v; }catch(e){ return fallback; } }
function lsSet(key,value){ try{ localStorage.setItem(key,value); }catch(e){ alert("No se pudo guardar en el dispositivo (storage bloqueado)."); } }

// init
if(!lsGet(K_EMP,null)){
  lsSet(K_EMP, JSON.stringify([{code:"1001",name:"Juan P√©rez",pin:"1111"},{code:"1002",name:"Mar√≠a L√≥pez",pin:"2222"}]));
}
if(!lsGet(K_REC,null)) lsSet(K_REC,"[]");

let currentEmp=null, adminTab="users", refreshTimer=null;
const $=id=>document.getElementById(id);
function toast(s){ const t=$("toast"); t.textContent=s; t.style.display="block"; clearTimeout(t._to); t._to=setTimeout(()=>t.style.display="none",2200); }
function norm(s){ return (s||"").trim().toLowerCase(); }
function pad2(n){ return String(n).padStart(2,"0"); }
function toLocalTime(iso){ const d=new Date(iso); return pad2(d.getHours())+":"+pad2(d.getMinutes())+":"+pad2(d.getSeconds()); }
function toLocalDateKey(iso){ const d=new Date(iso); return `${d.getFullYear()}-${pad2(d.getMonth()+1)}-${pad2(d.getDate())}`; }
function hoursToHMM(h){ const mins=Math.round(h*60); const H=Math.floor(mins/60); const M=mins%60; return `${H}h ${pad2(M)}m`; }
function mapsLink(lat,lng){ if(lat==null||lng==null) return ""; return `<a href="https://www.google.com/maps?q=${lat},${lng}" target="_blank" rel="noopener">Ver mapa</a>`; }
function coordText(r){
  const lat = r.lat ?? null, lng = r.lng ?? null;
  if(lat==null||lng==null) return "No disponible";
  const acc = r.precision==null ? "?" : Math.round(r.precision);
  return `<span class="mono">${Number(lat).toFixed(6)}, ${Number(lng).toFixed(6)}</span> <span class="pill">${acc}m</span> ¬∑ ${mapsLink(lat,lng)}`;
}
function downloadText(filename,text){
  const blob=new Blob([text],{type:"text/plain;charset=utf-8"});
  const a=document.createElement("a"); a.href=URL.createObjectURL(blob); a.download=filename;
  document.body.appendChild(a); a.click(); a.remove();
}

// === COMPAT: normaliza registros viejos/nuevos ===
function normalizeRecord(r){
  // Soporta formatos anteriores:
  // - {ts, iso, lat, lng, precision, empleado, codigo, tipo}
  // - {fecha, lat, lng, precision, empleado, codigo, tipo}
  const iso = r.fecha || r.iso || (r.ts ? new Date(r.ts).toISOString() : null);
  return {
    empleado: r.empleado || "",
    codigo: String(r.codigo ?? ""),
    tipo: r.tipo || "",
    fecha: iso,
    lat: (r.lat!==undefined)? r.lat : null,
    lng: (r.lng!==undefined)? r.lng : null,
    precision: (r.precision!==undefined)? r.precision : null
  };
}
function readAllRecords(){
  let arr=[];
  try{
    const raw = lsGet(K_REC,"[]");
    const parsed = JSON.parse(raw);
    if(Array.isArray(parsed)) arr = parsed.map(normalizeRecord).filter(x=>x.fecha);
  }catch(e){
    arr=[];
  }
  return arr;
}
function writeAllRecords(arr){
  // Guardamos en formato nuevo consistente
  lsSet(K_REC, JSON.stringify(arr));
  lsSet(K_TOUCH, String(Date.now()));
}

// login
function doLogin(){
  const u=$("user").value.trim();
  const p=$("pin").value.trim();
  if(u===ADMIN_USER && p===ADMIN_PIN){
    $("login").classList.add("hidden");
    $("adminWrap").classList.remove("hidden");
    loadEmps();
    initDayPicker();
    showAdminTab("users");
    return;
  }
  const emps = JSON.parse(lsGet(K_EMP,"[]"));
  const uN = norm(u);
  const emp = emps.find(e => (String(e.code).trim()===u) || (norm(e.name)===uN));
  if(!emp || String(emp.pin).trim()!==p){
    $("msg").textContent="Datos incorrectos (usa C√≥digo o Nombre + PIN)";
    return;
  }
  currentEmp=emp;
  $("login").classList.add("hidden");
  $("empWrap").classList.remove("hidden");
  $("empName").textContent=emp.name;
  $("empInfo").innerHTML=`<span class="pill">C√≥digo: ${emp.code}</span>`;
  renderEmpLast();
}
function logout(){ location.reload(); }

// tabs + refresh
function showAdminTab(which){
  adminTab=which;
  if(which==="users"){
    $("adminUsers").classList.remove("hidden");
    $("adminLogs").classList.add("hidden");
    $("tabUsers").classList.add("active");
    $("tabLogs").classList.remove("active");
    stopAutoRefresh();
  }else{
    $("adminUsers").classList.add("hidden");
    $("adminLogs").classList.remove("hidden");
    $("tabUsers").classList.remove("active");
    $("tabLogs").classList.add("active");
    initDayPicker();
    renderDay(true);
    startAutoRefresh();
  }
}
function startAutoRefresh(){ stopAutoRefresh(); refreshTimer=setInterval(()=>{ if(adminTab==="logs") renderDay(false); }, 1500); }
function stopAutoRefresh(){ if(refreshTimer){ clearInterval(refreshTimer); refreshTimer=null; } }
window.addEventListener("storage",(e)=>{ if(e.key===K_REC||e.key===K_TOUCH){ if(adminTab==="logs") renderDay(true); } });

// users CRUD
function loadEmps(){
  const emps = JSON.parse(lsGet(K_EMP,"[]")).sort((a,b)=>String(a.code).localeCompare(String(b.code)));
  const tb=$("empTable"); tb.innerHTML="";
  emps.forEach(e=>{
    const tr=document.createElement("tr");
    tr.innerHTML=`<td>${e.code}</td><td>${e.name}</td><td>${e.pin}</td>
      <td><button class="btn-inline" onclick="editEmp('${String(e.code)}')">Editar</button>
          <button class="btn-inline btn-danger" onclick="deleteEmp('${String(e.code)}')">Borrar</button></td>`;
    tb.appendChild(tr);
  });
}
function validateEmp(code,name,pin){
  if(!code||!name||!pin) return "Completa c√≥digo, nombre y PIN.";
  if(!/^[0-9]+$/.test(code)) return "El c√≥digo debe ser solo n√∫meros (ej. 1001).";
  if(!/^[0-9]{4,8}$/.test(pin)) return "El PIN debe tener 4 a 8 d√≠gitos.";
  return "";
}
function saveEmp(){
  const c=$("eCode").value.trim(), n=$("eName").value.trim(), p=$("ePin").value.trim();
  const err=validateEmp(c,n,p); if(err) return alert(err);
  let emps=JSON.parse(lsGet(K_EMP,"[]"));
  const i=emps.findIndex(x=>String(x.code).trim()===c);
  if(i>=0) emps[i]={code:c,name:n,pin:p}; else emps.push({code:c,name:n,pin:p});
  lsSet(K_EMP, JSON.stringify(emps));
  clearEmpFields(); loadEmps();
  toast("‚úÖ Usuario guardado. Entra con C√≥digo o Nombre + PIN.");
}
function clearEmpFields(){ $("eCode").value=""; $("eName").value=""; $("ePin").value=""; }
function editEmp(code){
  const e=JSON.parse(lsGet(K_EMP,"[]")).find(x=>String(x.code).trim()===String(code).trim());
  if(!e) return; $("eCode").value=e.code; $("eName").value=e.name; $("ePin").value=e.pin; toast("Editando "+e.code);
}
function deleteEmp(code){
  if(!confirm("¬øBorrar este empleado?")) return;
  let emps=JSON.parse(lsGet(K_EMP,"[]")).filter(x=>String(x.code).trim()!==String(code).trim());
  lsSet(K_EMP, JSON.stringify(emps)); loadEmps(); toast("Usuario borrado");
}

// employee record
function mark(tipo){
  if(!currentEmp) return;
  if(!navigator.geolocation){ saveRecord(tipo,null); return; }
  navigator.geolocation.getCurrentPosition(
    pos=>saveRecord(tipo,pos),
    err=>saveRecord(tipo,null),
    {enableHighAccuracy:true, timeout:9000, maximumAge:0}
  );
}
function saveRecord(tipo,pos){
  const recs = readAllRecords(); // ya normalizados
  const nowIso = new Date().toISOString();
  recs.push({
    empleado: currentEmp.name,
    codigo: String(currentEmp.code),
    tipo: tipo,
    fecha: nowIso,
    lat: pos ? pos.coords.latitude : null,
    lng: pos ? pos.coords.longitude : null,
    precision: pos ? pos.coords.accuracy : null
  });
  writeAllRecords(recs);
  toast("‚úÖ "+tipo+" registrada");
  renderEmpLast();
}
function renderEmpLast(){
  const today = toLocalDateKey(new Date().toISOString());
  const recs = readAllRecords()
    .filter(r=>String(r.codigo)===String(currentEmp.code) && toLocalDateKey(r.fecha)===today)
    .sort((a,b)=>new Date(b.fecha)-new Date(a.fecha))
    .slice(0,6);
  if(recs.length===0){ $("empLast").innerHTML=`<div class="subtle">A√∫n no hay registros hoy.</div>`; return; }
  const rows=recs.map(r=>`<tr><td><span class="pill">${r.tipo}</span></td><td>${toLocalTime(r.fecha)}</td><td>${coordText(r)}</td></tr>`).join("");
  $("empLast").innerHTML=`<table><thead><tr><th>Tipo</th><th>Hora</th><th>Ubicaci√≥n</th></tr></thead><tbody>${rows}</tbody></table>`;
}

// admin day view
function initDayPicker(){
  const dp=$("dayPicker");
  if(!dp.value){
    const now=new Date();
    dp.value=`${now.getFullYear()}-${pad2(now.getMonth()+1)}-${pad2(now.getDate())}`;
  }
  dp.onchange=()=>renderDay(true);
}
function setToday(){
  const now=new Date();
  $("dayPicker").value=`${now.getFullYear()}-${pad2(now.getMonth()+1)}-${pad2(now.getDate())}`;
  renderDay(true);
}
function getDayRecords(dayKey){
  return readAllRecords().filter(r=>toLocalDateKey(r.fecha)===dayKey);
}
function renderDay(){
  const dayKey=$("dayPicker").value;
  const dayRecs=getDayRecords(dayKey);

  const byEmp={};
  dayRecs.forEach(r=>{
    const k=String(r.codigo||r.empleado);
    if(!byEmp[k]) byEmp[k]=[];
    byEmp[k].push(r);
  });

  const empKeys=Object.keys(byEmp).sort((a,b)=>a.localeCompare(b));
  if(empKeys.length===0){
    $("daySummary").innerHTML=`<div class="pill">Sin registros para ${dayKey}</div>`;
    $("dayDetails").innerHTML=`<div class="subtle" style="margin-top:10px">No hay registros para este d√≠a.</div>`;
    return;
  }

  const summaryRows=[], detailsBlocks=[];
  empKeys.forEach(k=>{
    const arr=byEmp[k].slice().sort((a,b)=>new Date(a.fecha)-new Date(b.fecha));
    const name=arr[0]?.empleado||k;

    let totalHours=0;
    const pairs=[];
    let pending=null;

    arr.forEach(r=>{
      if(r.tipo==="Entrada"){
        if(pending) pairs.push({entrada:pending, salida:null});
        pending=r;
      }else if(r.tipo==="Salida"){
        if(pending){
          const start=new Date(pending.fecha).getTime();
          const end=new Date(r.fecha).getTime();
          if(end>=start) totalHours += (end-start)/3600000;
          pairs.push({entrada:pending, salida:r});
          pending=null;
        }else{
          pairs.push({entrada:null, salida:r});
        }
      }
    });
    if(pending) pairs.push({entrada:pending, salida:null});

    summaryRows.push(`<tr><td>${name}</td><td><b>${hoursToHMM(totalHours)}</b></td><td><span class="pill">${k}</span></td></tr>`);

    let rows="";
    pairs.forEach((p,idx)=>{
      const e=p.entrada, s=p.salida;
      const eTime=e?toLocalTime(e.fecha):"‚Äî";
      const sTime=s?toLocalTime(s.fecha):"‚Äî";
      const eLoc=e?coordText(e):"‚Äî";
      const sLoc=s?coordText(s):(e?"<i>Pendiente</i>":"‚Äî");

      let tramo="‚Äî";
      if(e&&s){
        const start=new Date(e.fecha).getTime(), end=new Date(s.fecha).getTime();
        if(end>=start) tramo=hoursToHMM((end-start)/3600000);
      }else if(e&&!s) tramo="<i>Pendiente</i>";
      else if(!e&&s) tramo="<i>Salida sin entrada</i>";

      rows += `<tr><td>${idx+1}</td>
        <td>${eTime}<div class="subtle">${eLoc}</div></td>
        <td>${sTime}<div class="subtle">${sLoc}</div></td>
        <td>${tramo}</td></tr>`;
    });

    detailsBlocks.push(`<div class="card" style="margin-top:12px">
      <h4 style="margin:0 0 8px 0">${name} <span class="pill">C√≥digo: ${k}</span> <span class="pill">Total: ${hoursToHMM(totalHours)}</span></h4>
      <table><thead><tr><th>#</th><th>Entrada</th><th>Salida</th><th>Horas</th></tr></thead><tbody>${rows}</tbody></table>
    </div>`);
  });

  $("daySummary").innerHTML=`<table><thead><tr><th>Empleado</th><th>Total</th><th>C√≥digo</th></tr></thead><tbody>${summaryRows.join("")}</tbody></table>`;
  $("dayDetails").innerHTML=detailsBlocks.join("");
}

function exportDayCSV(){
  const dayKey=$("dayPicker").value;
  const dayRecs=getDayRecords(dayKey).slice().sort((a,b)=>new Date(a.fecha)-new Date(b.fecha));
  if(dayRecs.length===0) return alert("No hay registros para ese d√≠a.");
  const header=["fecha_iso","fecha_dia","hora_local","codigo","empleado","tipo","lat","lng","precision_m","maps"].join(",");
  const lines=dayRecs.map(r=>{
    const maps=(r.lat==null||r.lng==null)?"":`https://www.google.com/maps?q=${r.lat},${r.lng}`;
    return [r.fecha,dayKey,toLocalTime(r.fecha),r.codigo,r.empleado,r.tipo,r.lat??"",r.lng??"",r.precision??"",maps]
      .map(v=>String(v).replaceAll('"','""')).map(v=>`"${v}"`).join(",");
  });
  downloadText(`asistencia_${dayKey}.csv`, header+"\n"+lines.join("\n"));
}
function deleteDay(){
  const dayKey=$("dayPicker").value;
  if(!confirm(`¬øBorrar TODOS los registros del d√≠a ${dayKey}?`)) return;
  const kept = readAllRecords().filter(r=>toLocalDateKey(r.fecha)!==dayKey);
  writeAllRecords(kept);
  renderDay(true); toast("Registros del d√≠a borrados");
}
function clearRecords(){
  if(!confirm("¬øBorrar TODOS los registros?")) return;
  writeAllRecords([]); toast("Registros borrados");
  if(adminTab==="logs") renderDay(true);
}
function diagnostico(){
  const all = readAllRecords();
  const keys = Object.keys(localStorage).slice(0,50).join(", ");
  alert("Registros totales (en este dispositivo): "+all.length+"\n\nClaves en localStorage (muestra parcial):\n"+keys);
}
</script>
</body>
</html>
